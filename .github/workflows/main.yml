
name: douban sync

on:
  schedule:
    # GitHub cron uses UTC. 15:05 UTC = 23:05 Asia/Shanghai
    - cron: "5 15 * * *"
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: douban-sync
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 关键：同步前删除旧数据，避免“增量不产生 diff 导致不 commit”
      - name: Reset data directory
        shell: bash
        run: |
          set -Eeuo pipefail
          rm -rf ./data
          mkdir -p ./data

      - name: Movie Sync (JSON only)
        uses: lizheming/doumark-action@master
        with:
          id: somkanel
          type: movie
          format: json
          dir: ./data
          cookie: ${{ secrets.DOUBAN_COOKIE }}

      # 可选但强烈建议：打印一下到底有没有生成文件、git 有没有变更
      - name: Debug status
        shell: bash
        run: |
          set -Eeuo pipefail
          echo "=== data files ==="
          ls -lah ./data || true
          echo "=== git status ==="
          git status --porcelain=v1
          echo "=== git diff (stat) ==="
          git diff --stat || true

      - name: Commit and Push
        uses: EndBug/add-and-commit@v9
        with:
          message: "chore: update douban data"
          add: "./data"
          default_author: github_actions
